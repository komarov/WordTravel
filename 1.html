<html>
<body>
<script type="text/javascript" src="raphael-min.js"></script>

<script type="text/javascript">

var DEBUG = true;

Raphael.el.getHotSpot = function() {
   var bbox = this.getBBox();
   return { 
      x: bbox.x + bbox.width / 2, 
      y: bbox.y + bbox.height / 2
   };
};

function getFrame() {

   var frame = {
      'Links': [
         [
            '8EC0B16E-E7EB-11DE-B3BD-C724A05985A0',
            '8EC99946-E7EB-11DE-B3BD-C724A05985A0'
         ],
         [
            '8EC99946-E7EB-11DE-B3BD-C724A05985A0',
            '8ED02950-E7EB-11DE-B3BD-C724A05985A0'
         ],
         [
            '8ED02950-E7EB-11DE-B3BD-C724A05985A0',
            '8ED9AF20-E7EB-11DE-B3BD-C724A05985A0'
         ],
         [
            '8ED02950-E7EB-11DE-B3BD-C724A05985A0',
            '8EDA547A-E7EB-11DE-B3BD-C724A05985A0'
         ]
      ],
      'Words': {
         '8EC0B16E-E7EB-11DE-B3BD-C724A05985A0': 'aBc',
         '8ED9AF20-E7EB-11DE-B3BD-C724A05985A0': 'secretskdlgksjdklgjhsdklgjdhslkdh',
         '8ED02950-E7EB-11DE-B3BD-C724A05985A0': 'real',
         '8EC99946-E7EB-11DE-B3BD-C724A05985A0': '123',
         '8EDA547A-E7EB-11DE-B3BD-C724A05985A0': '.......'
      }
   };

   return frame;
}

function drawWord( paper, word, width, height, x, y, round ) {


   var text = paper.text( x, y, word ).attr( { fill: "#fff" } );
  
   var textBB = text.getBBox();
   if( DEBUG ) console.log( textBB );
   var rect = paper.rect( textBB.x - round, textBB.y - round, textBB.width + 2 * round, textBB.height + 2 * round, round ).attr( {fill: "#223fa3" } );
   text.toFront();
   return rect;
}

function isFree( places, x, y ) {

   var R = 50;
   for( var place in places ) {
      if( places.hasOwnProperty( place ) ) {
         occupied = places[ place ].getBBox(); 
         if( ( x <= occupied.x + R && x >= occupied.x - R ) || ( y <= occupied.y + R && y >= occupied.y - R ) ) {
            return false;
         }
      }
   }
   
   return true;

}

function stickToEdges( x, y, width, height, h ) {

   if( x < h || y < h || x > width - h || y > height - h ) {
      return true;
   }
   
   return false;
   
}

function drawFrame( paper, frame ) {

   var placedWords = {};
   if( DEBUG ) console.log( paper );
   for( var wordUID in frame.Words ) {
      if( frame.Words.hasOwnProperty( wordUID ) ) {
         var x = Math.random() * paper.width;
         var y = Math.random() * paper.height;

         while( !isFree( placedWords, x, y ) || ( stickToEdges( x, y, paper.width, paper.height, 30 ) ) ) {
            x = Math.random() * paper.width;
            y = Math.random() * paper.height;      
         }

         placedWords[ wordUID ] = drawWord( paper, frame.Words[ wordUID ], 60, 20, x, y, 3 );
         if( DEBUG ) console.log( placedWords );
         if( DEBUG ) console.log( placedWords[ wordUID ] );
      }
   }

   for( var index in frame.Links ) {
      if( frame.Links.hasOwnProperty( index ) ) {
         var link = frame.Links[ index ];
         var hotSpot_0 =  placedWords[ link[ 0 ] ].getHotSpot();
         var hotSpot_1 =  placedWords[ link[ 1 ] ].getHotSpot();

         var path = "M" + hotSpot_0.x + " " + hotSpot_0.y + "L" + hotSpot_1.x + " " + hotSpot_1.y;
         paper.path( path ).toBack();

      }


   }
}


window.onload = function() { 

   var newFrame = getFrame();
   //alert( newFrame[ 'Words' ][ '8EC0B16E-E7EB-11DE-B3BD-C724A05985A0' ] );

   var paperWidth = 600;
   var paperHeight = 400;
   var centerX =  window.innerWidth / 2;
   var centerY =  window.innerHeight / 2;
   var startX = centerX - paperWidth / 2;
   var startY = centerY - paperHeight / 2;

   var paper = new Raphael( document.getElementById('raphael_canvas'), paperWidth, paperHeight );

   drawFrame( paper, newFrame );
   

}


</script>

<div id="raphael_canvas" align="center" style="background-color:silver;width:600px" ></div>

</body>
</html>
